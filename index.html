<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­å€‰å„²æç©è¦åŠƒç³»çµ± (å°ç« è¤‡è£½ç‰ˆ)</title>
    <!-- å¼•å…¥ Tesseract.js ç”¨æ–¼æ–‡å­—è¾¨è­˜ -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* é ‚éƒ¨ç‹€æ…‹åˆ— */
        .header-bar { text-align: center; margin-bottom: 15px; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.8rem; }
        .formula-info { color: #e67e22; font-weight: bold; font-size: 0.9rem; margin-top: 5px; }

        /* å·¥å…·åˆ— */
        .toolbar { 
            background: white; padding: 12px; border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; 
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center;
            position: sticky; top: 10px; z-index: 100; border: 1px solid #ddd;
        }
        
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95rem; font-weight: bold; transition: 0.2s; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-success { background-color: #27ae60; color: white; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-warning { background-color: #f39c12; color: white; }
        .btn-clone-active { background-color: #8e44ad; color: white; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(142, 68, 173, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(142, 68, 173, 0); } 100% { box-shadow: 0 0 0 0 rgba(142, 68, 173, 0); } }

        /* æ¨¡å¼åˆ‡æ› */
        .mode-switch { display: flex; background: #eee; padding: 4px; border-radius: 20px; margin: 0 10px; }
        .mode-option { padding: 6px 15px; border-radius: 16px; cursor: pointer; font-size: 0.9rem; user-select: none; }
        .mode-option.active { background: #3498db; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        #file-input { display: none; }

        /* ä¸»å®¹å™¨ */
        .main-container { display: flex; gap: 20px; width: 100%; max-width: 1400px; height: 80vh; }
        
        /* ç•«å¸ƒå€ */
        .canvas-wrapper {
            flex: 3;
            border: 2px solid #bdc3c7; background: #fff;
            position: relative; overflow: auto;
            border-radius: 8px;
            /* æ ¼ç·šèƒŒæ™¯ */
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* è¤‡è£½æ¨¡å¼ä¸‹çš„æ¸¸æ¨™æ¨£å¼ */
        .cursor-clone { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewport="0 0 24 24" fill="%238e44ad"><circle cx="12" cy="12" r="10"/></svg>') 12 12, crosshair !important; }

        /* æ•¸æ“šåˆ—è¡¨ */
        .data-panel {
            flex: 1; background: white; padding: 0; border-radius: 8px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            overflow: hidden;
        }
        .data-header { padding: 15px; background: #34495e; color: white; font-weight: bold; }
        .table-container { flex: 1; overflow-y: auto; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #ecf0f1; position: sticky; top: 0; z-index: 2; color: #2c3e50; }
        tr:hover { background: #f9f9f9; cursor: pointer; }
        .total-row { background: #d5f5e3; font-weight: bold; color: #27ae60; font-size: 1.1rem; }

        /* å½ˆçª—æ¨£å¼ */
        #input-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 340px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; color: #555; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end; }
        
        /* è¼‰å…¥é®ç½© */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header-bar">
        <h1>ğŸ“¦ å°ˆæ¥­å€‰å„²æç©è¦åŠƒç³»çµ±</h1>
        <div class="formula-info">ğŸ’¡ ç‰¹æ®Šå…¬å¼ï¼š(å¯¬xæ·±xé«˜)/28317ï¼Œå€‹ä½æ•¸ < 5 æ¨å»ï¼Œâ‰¥ 5 é€²ä½è‡³åä½æ•¸</div>
    </div>

    <div class="toolbar">
        <button class="btn-primary" onclick="document.getElementById('file-input').click()">ğŸ“‚ å°å…¥å¹³é¢åœ–</button>
        <input type="file" id="file-input" accept="image/*" onchange="handleImageUpload(event)">
        
        <div class="mode-switch">
            <div class="mode-option active" id="mode-manual" onclick="setMode('manual')">ğŸ‘† ä¸€èˆ¬é»é¸</div>
            <div class="mode-option" id="mode-ocr" onclick="setMode('ocr')">ğŸ“ OCR æŠ“å–å°ºå¯¸</div>
        </div>

        <!-- è¤‡è£½æ¨¡å¼çš„é¡¯ç¤ºå€åŸŸ -->
        <div id="clone-status" style="display:none; align-items: center; gap: 10px; background: #f3e5f5; padding: 5px 10px; border-radius: 4px; border: 1px solid #9c27b0;">
            <span style="color:#8e44ad; font-weight:bold;">ğŸ“‹ å°ç« è¤‡è£½ä¸­...</span>
            <button class="btn-danger" style="padding:4px 8px; font-size:0.8rem;" onclick="stopCloneMode()">çµæŸè¤‡è£½</button>
        </div>

        <div style="flex:1;"></div> <!-- ä½”ä½ç¬¦ï¼ŒæŠŠå¾Œé¢æŒ‰éˆ•æ¨åˆ°å³é‚Š -->

        <button class="btn-success" onclick="exportImage()">ğŸ’¾ å­˜åœ–</button>
        <button class="btn-success" onclick="exportCSV()">ğŸ“Š å­˜è¡¨</button>
        <button class="btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>

    <div class="main-container">
        <div class="canvas-wrapper" id="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
        </div>

        <div class="data-panel">
            <div class="data-header">æç©æ˜ç´°æ¸…å–®</div>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th style="width:30%">ç·¨è™Ÿ</th>
                            <th>å°ºå¯¸ (cm)</th>
                            <th style="width:20%">æç©</th>
                            <th style="width:10%"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <table style="margin-top: auto;">
                <tr class="total-row">
                    <td colspan="2" style="text-align: right;">ç¸½è¨ˆï¼š</td>
                    <td id="totalVolume">0</td>
                    <td>æ</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ç·¨è¼¯/è¼¸å…¥ å½ˆçª— -->
    <div id="input-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#2c3e50;">å€‰ä½è¨­å®š</h3>
            <div class="form-group" style="margin-bottom:15px;">
                <label>ç·¨è™Ÿåç¨± (è‡ªå‹•éå¢):</label>
                <input type="text" id="dim-name" placeholder="ä¾‹å¦‚: A-01">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å¯¬ (W)</label>
                    <input type="number" id="dim-w">
                </div>
                <div class="form-group">
                    <label>æ·± (D)</label>
                    <input type="number" id="dim-d">
                </div>
                <div class="form-group">
                    <label>é«˜ (H)</label>
                    <input type="number" id="dim-h">
                </div>
            </div>
            
            <div style="background:#f8f9fa; padding:10px; border-radius:4px; margin-bottom:15px;">
                <label style="font-size:0.85rem; color:#7f8c8d;">è©¦ç®—æç© (é€²ä½å¾Œ):</label>
                <div id="preview-vol" style="font-size:1.5rem; font-weight:bold; color:#e67e22; text-align:center;">0</div>
            </div>

            <div class="modal-footer">
                <button class="btn-danger" id="btn-delete" onclick="deleteMarker()">åˆªé™¤</button>
                <button class="btn-primary" id="btn-start-clone" style="background-color: #8e44ad;" onclick="startCloneModeFromModal()">ğŸ“‹ è¨­ç‚ºè¤‡è£½ä¾†æº</button>
                <div style="flex:1;"></div>
                <button class="btn-warning" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-success" onclick="saveMarker()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>å½±åƒè™•ç†ä¸­...</p>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const modal = document.getElementById('input-modal');
        
        let bgImage = new Image();
        let markers = []; 
        let isImageLoaded = false;
        
        // ç‹€æ…‹è®Šæ•¸
        let currentMode = 'manual'; // manual, ocr
        let isCloneMode = false;
        let cloneSourceData = null; // å„²å­˜è¦è¢«è¤‡è£½çš„æ•¸æ“šæ¨£æ¿
        
        // OCR æ¡†é¸è®Šæ•¸
        let isDragging = false;
        let startX, startY, endX, endY;
        
        // æš«å­˜è®Šæ•¸
        let editingIndex = -1; 
        let tempCoords = {x:0, y:0};

        // --- 1. æ ¸å¿ƒé‚è¼¯ï¼šç‰¹æ®Šæç©è¨ˆç®— ---
        function calculateSpecialVolume(w, d, h) {
            // æ­¥é©Ÿ 1: åŸå§‹æ›ç®—
            let rawVal = (w * d * h) / 28317;
            
            // æ­¥é©Ÿ 2: å››æ¨äº”å…¥åˆ°æœ€è¿‘çš„ 10 (å¯¦ç¾å€‹ä½æ•¸ <5 æ¨å», >=5 é€²ä½)
            // Math.round(124 / 10) -> 12 * 10 = 120
            // Math.round(125 / 10) -> 13 * 10 = 130
            let roundedVal = Math.round(rawVal / 10) * 10;
            
            return roundedVal;
        }

        // å³æ™‚é è¦½è¨ˆç®— (ç¶å®šè¼¸å…¥æ¡†)
        function updatePreview() {
            const w = document.getElementById('dim-w').value || 0;
            const d = document.getElementById('dim-d').value || 0;
            const h = document.getElementById('dim-h').value || 0;
            document.getElementById('preview-vol').innerText = calculateSpecialVolume(w, d, h);
        }
        ['dim-w', 'dim-d', 'dim-h'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });


        // --- 2. åœ–ç‰‡è™•ç† ---
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                bgImage = new Image();
                bgImage.onload = function() {
                    canvas.width = bgImage.width;
                    canvas.height = bgImage.height;
                    isImageLoaded = true;
                    // è®“ç•«å¸ƒå¯¬åº¦é©æ‡‰
                    if(bgImage.width > canvasWrapper.clientWidth) {
                        canvas.style.width = '100%';
                        canvas.style.height = 'auto';
                    } else {
                        canvas.style.width = '';
                        canvas.style.height = '';
                    }
                    redraw();
                }
                bgImage.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }

        // --- 3. äº’å‹•èˆ‡æ¨¡å¼æ§åˆ¶ ---
        function setMode(mode) {
            if(isCloneMode) stopCloneMode(); // åˆ‡æ›æ¨¡å¼æ™‚å¼·åˆ¶åœæ­¢è¤‡è£½
            currentMode = mode;
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');
            updateCursor();
        }

        function updateCursor() {
            if (isCloneMode) {
                canvas.classList.add('cursor-clone');
            } else {
                canvas.classList.remove('cursor-clone');
                canvas.style.cursor = currentMode === 'ocr' ? 'crosshair' : 'default';
            }
        }

        // --- 4. è¤‡è£½æ¨¡å¼é‚è¼¯ (å°ç« åŠŸèƒ½) ---
        function startCloneModeFromModal() {
            // å¾å½ˆçª—ä¸­å–å¾—ç•¶å‰æ•¸æ“šä½œç‚ºæ¨£æ¿
            const w = parseFloat(document.getElementById('dim-w').value);
            const d = parseFloat(document.getElementById('dim-d').value);
            const h = parseFloat(document.getElementById('dim-h').value);
            const name = document.getElementById('dim-name').value;

            if (isNaN(w) || isNaN(d) || isNaN(h)) {
                alert("è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„å°ºå¯¸æ‰èƒ½é–‹å§‹è¤‡è£½");
                return;
            }

            // å¦‚æœæ˜¯æ–°å¢ç‹€æ…‹ï¼Œå…ˆå­˜æª”
            if (editingIndex === -1) {
                saveMarker();
                // å­˜æª”å¾Œ editingIndex æœƒè®Šå› -1ï¼Œä½† markers æœ€å¾Œä¸€å€‹å°±æ˜¯å‰›å­˜çš„
                cloneSourceData = markers[markers.length - 1];
            } else {
                // å¦‚æœæ˜¯ç·¨è¼¯ç‹€æ…‹ï¼Œç›´æ¥å­˜
                saveMarker();
                cloneSourceData = markers[editingIndex]; // æ³¨æ„ saveMarker æœƒé‡ç½® editingIndexï¼Œé€™è£¡é‚è¼¯è¦å°å¿ƒ
                // ä¿®æ­£ï¼šsaveMarker æœƒæŠŠ editingIndex è¨­ç‚º -1ã€‚
                // å…¶å¯¦å¯ä»¥ç›´æ¥ç”¨ä¸Šé¢æŠ“åˆ°çš„ w,d,h å»ºç«‹ç‰©ä»¶
                cloneSourceData = { w, d, h, name }; 
            }
            
            // å•Ÿå‹•è¤‡è£½æ¨¡å¼
            isCloneMode = true;
            document.getElementById('clone-status').style.display = 'flex';
            updateCursor();
        }

        function stopCloneMode() {
            isCloneMode = false;
            cloneSourceData = null;
            document.getElementById('clone-status').style.display = 'none';
            updateCursor();
        }

        // æ™ºæ…§å‘½å (è‡ªå‹•éå¢)
        function incrementName(name) {
            // å°‹æ‰¾å­—ä¸²æœ«å°¾çš„æ•¸å­—
            return name.replace(/(\d+)$/, (match) => {
                const num = parseInt(match, 10) + 1;
                // ä¿æŒåŸæœ¬çš„è£œé›¶æ ¼å¼ (ä¾‹å¦‚ 01 -> 02)
                return num.toString().padStart(match.length, '0');
            });
        }

        // --- 5. Canvas äº‹ä»¶ ---
        canvas.addEventListener('mousedown', function(e) {
            if (!isImageLoaded) return;
            const {x, y} = getCanvasCoordinates(e);

            // A. è¤‡è£½æ¨¡å¼å„ªå…ˆè™•ç†
            if (isCloneMode && cloneSourceData) {
                // 1. è‡ªå‹•ç”¢ç”Ÿæ–°åç¨±
                const newName = incrementName(cloneSourceData.name);
                // 2. æ›´æ–°æ¨£æ¿åç¨±ä»¥ä¾¿ä¸‹æ¬¡ç¹¼çºŒéå¢
                cloneSourceData.name = newName;
                
                // 3. è¨ˆç®—æç© (é›–ç„¶å°ºå¯¸ä¸€æ¨£ï¼Œé‚„æ˜¯è·‘ä¸€æ¬¡å…¬å¼ç¢ºä¿ä¸€è‡´)
                const vol = calculateSpecialVolume(cloneSourceData.w, cloneSourceData.d, cloneSourceData.h);
                
                // 4. ç›´æ¥åŠ å…¥æ¨™è¨˜
                markers.push({
                    x: x, y: y,
                    w: cloneSourceData.w,
                    d: cloneSourceData.d,
                    h: cloneSourceData.h,
                    name: newName,
                    volume: vol,
                    text: `${vol}`
                });
                
                updateTable();
                redraw();
                return; // çµæŸï¼Œä¸è§¸ç™¼å…¶ä»–æ“ä½œ
            }

            // B. é»æ“Šç¾æœ‰æ¨™è¨˜ (ç·¨è¼¯)
            const clickedIndex = findClickedMarker(x, y);
            if (clickedIndex !== -1) {
                openModal(clickedIndex);
                return;
            }

            // C. æ‰‹å‹•æ–°å¢æ¨¡å¼
            if (currentMode === 'manual') {
                tempCoords = {x, y};
                openModal(-1);
                return;
            }

            // D. OCR æ¨¡å¼ (é–‹å§‹æ‹–æ›³)
            if (currentMode === 'ocr') {
                isDragging = true;
                startX = x; startY = y;
            }
        });

        // OCR æ‹–æ›³è¦–è¦ºæ•ˆæœ
        canvas.addEventListener('mousemove', function(e) {
            if (!isDragging || currentMode !== 'ocr') return;
            const {x, y} = getCanvasCoordinates(e);
            endX = x; endY = y;
            redraw();
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 3]);
            ctx.strokeRect(startX, startY, endX - startX, endY - startY);
            ctx.setLineDash([]);
        });

        // OCR çµæŸæ‹–æ›³
        canvas.addEventListener('mouseup', function(e) {
            if (!isDragging) return;
            isDragging = false;
            const w = Math.abs(endX - startX);
            const h = Math.abs(endY - startY);
            if (w < 10 || h < 10) return;
            const rectX = Math.min(startX, endX);
            const rectY = Math.min(startY, endY);
            tempCoords = {x: rectX, y: rectY};
            performOCR(rectX, rectY, w, h);
        });

        // åº§æ¨™è½‰æ›
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        // --- 6. OCR åŸ·è¡Œ ---
        async function performOCR(x, y, w, h) {
            document.getElementById('loading-overlay').style.display = 'flex';
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w; tempCanvas.height = h;
            tempCanvas.getContext('2d').drawImage(bgImage, x, y, w, h, 0, 0, w, h);
            
            try {
                const result = await Tesseract.recognize(tempCanvas, 'eng'); // æ•¸å­—ç”¨è‹±æ–‡æ¨¡å‹å³å¯
                const numbers = result.data.text.match(/\d+/g);
                document.getElementById('loading-overlay').style.display = 'none';
                
                openModal(-1);
                if (numbers && numbers.length >= 2) {
                    document.getElementById('dim-w').value = numbers[0];
                    document.getElementById('dim-d').value = numbers[1];
                    // å¦‚æœæŠ“åˆ°ä¸‰å€‹æ•¸å­—å°±å¡«é«˜ï¼Œæ²’æœ‰å°±ç•™ç©º
                    if(numbers[2]) document.getElementById('dim-h').value = numbers[2];
                }
                updatePreview();
            } catch (err) {
                document.getElementById('loading-overlay').style.display = 'none';
                openModal(-1);
            }
        }

        // --- 7. å½ˆçª—èˆ‡æ•¸æ“šç®¡ç† ---
        function openModal(index) {
            editingIndex = index;
            modal.style.display = 'flex';
            const btnDelete = document.getElementById('btn-delete');
            const btnClone = document.getElementById('btn-start-clone');
            
            // è‡ªå‹•ç”Ÿæˆåç¨±é è¨­å€¼
            let nextName = "A-01";
            if (markers.length > 0) {
                // å˜—è©¦æŠ“å–æœ€å¾Œä¸€å€‹çš„åç¨±ä¸¦éå¢
                nextName = incrementName(markers[markers.length-1].name);
            }

            if (index === -1) {
                // æ–°å¢
                btnDelete.style.display = 'none';
                btnClone.innerText = "å„²å­˜ä¸¦é–‹å§‹è¤‡è£½";
                // è‹¥ä¸æ˜¯ OCR å¡«å…¥çš„ï¼Œå‰‡æ¸…ç©º
                if (currentMode === 'manual') {
                    document.getElementById('dim-name').value = nextName;
                    document.getElementById('dim-w').value = '';
                    document.getElementById('dim-d').value = '';
                    document.getElementById('dim-h').value = '';
                } else if (!document.getElementById('dim-name').value) {
                    document.getElementById('dim-name').value = nextName;
                }
            } else {
                // ç·¨è¼¯
                btnDelete.style.display = 'block';
                btnClone.innerText = "ğŸ“‹ ä»¥æ­¤ç‚ºæ¨£æ¿è¤‡è£½";
                const m = markers[index];
                document.getElementById('dim-name').value = m.name;
                document.getElementById('dim-w').value = m.w;
                document.getElementById('dim-d').value = m.d;
                document.getElementById('dim-h').value = m.h;
            }
            updatePreview();
        }

        function closeModal() {
            modal.style.display = 'none';
            redraw();
        }

        function saveMarker() {
            const w = parseFloat(document.getElementById('dim-w').value);
            const d = parseFloat(document.getElementById('dim-d').value);
            const h = parseFloat(document.getElementById('dim-h').value);
            const name = document.getElementById('dim-name').value || 'æœªå‘½å';

            if (isNaN(w) || isNaN(d) || isNaN(h)) {
                alert("è«‹è¼¸å…¥å®Œæ•´å°ºå¯¸");
                return;
            }

            const volume = calculateSpecialVolume(w, d, h);
            
            const markerData = {
                x: editingIndex === -1 ? tempCoords.x : markers[editingIndex].x,
                y: editingIndex === -1 ? tempCoords.y : markers[editingIndex].y,
                w, d, h, name, volume,
                text: `${volume}`
            };

            if (editingIndex === -1) {
                markers.push(markerData);
            } else {
                markers[editingIndex] = markerData;
            }

            editingIndex = -1; // é‡ç½®
            updateTable();
            redraw();
            closeModal();
        }

        function deleteMarker() {
            if (editingIndex !== -1) {
                markers.splice(editingIndex, 1);
                updateTable();
                redraw();
                closeModal();
            }
        }

        function findClickedMarker(x, y) {
            // ç°¡å–®ç¢°æ’æª¢æ¸¬ï¼Œæª¢æ¸¬ç¯„åœç‚ºæ¨™ç±¤å¤§å°
            // é€™è£¡å‡è¨­æ¨™ç±¤å¤§ç´„ 100x60ï¼Œå€’åºæª¢æ¸¬
            for (let i = markers.length - 1; i >= 0; i--) {
                const m = markers[i];
                if (x >= m.x && x <= m.x + 120 && y >= m.y && y <= m.y + 60) {
                    return i;
                }
            }
            return -1;
        }

        // --- 8. ç¹ªåœ–èˆ‡è¡¨æ ¼ ---
        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (isImageLoaded) ctx.drawImage(bgImage, 0, 0);
            markers.forEach(drawMarker);
        }

        function drawMarker(m) {
            const padding = 8;
            const fontSize = 24; 
            ctx.font = `bold ${fontSize}px Microsoft JhengHei`;
            
            const textWidth = ctx.measureText(m.text).width;
            const nameWidth = ctx.measureText(m.name).width;
            const boxWidth = Math.max(textWidth, nameWidth) + 25;
            const boxHeight = 65;

            // æ¨™ç±¤èƒŒæ™¯ (åŠé€æ˜é»‘)
            ctx.fillStyle = "rgba(40, 40, 40, 0.85)";
            ctx.beginPath();
            ctx.roundRect(m.x, m.y, boxWidth, boxHeight, 8);
            ctx.fill();

            // æç© (å¤§å­— é»ƒè‰²)
            ctx.fillStyle = "#f1c40f";
            ctx.fillText(m.text, m.x + 10, m.y + fontSize + 5);

            // ç·¨è™Ÿ (å°å­— ç™½è‰²)
            ctx.font = `16px Microsoft JhengHei`;
            ctx.fillStyle = "#ecf0f1";
            ctx.fillText(m.name, m.x + 10, m.y + fontSize + 28);
            
            // ç´…é»å®šä½
            ctx.beginPath();
            ctx.arc(m.x, m.y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = "#e74c3c";
            ctx.fill();
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let total = 0;

            markers.forEach((m, index) => {
                total += m.volume;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${m.name}</strong></td>
                    <td style="font-size:0.85rem; color:#666;">${m.w}x${m.d}x${m.h}</td>
                    <td style="color:#e67e22; font-weight:bold;">${m.volume}</td>
                    <td><button class="btn-danger" style="padding:2px 6px; font-size:12px;" onclick="removeOne(${index})">X</button></td>
                `;
                tr.onclick = (e) => {
                    if(e.target.tagName !== 'BUTTON') openModal(index);
                };
                tbody.appendChild(tr);
            });
            document.getElementById('totalVolume').innerText = total;
        }

        function removeOne(index) {
            event.stopPropagation();
            markers.splice(index, 1);
            updateTable();
            redraw();
        }

        function clearAll() {
            if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) {
                markers = [];
                updateTable();
                redraw();
            }
        }

        // --- 9. å°å‡º ---
        function exportImage() {
            if (!isImageLoaded) return;
            const link = document.createElement('a');
            link.download = 'å€‰ä½è¦åŠƒåœ–.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        function exportCSV() {
            let csv = "\uFEFFç·¨è™Ÿ,å¯¬,æ·±,é«˜,æç©\n";
            markers.forEach(m => {
                csv += `${m.name},${m.w},${m.d},${m.h},${m.volume}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "å€‰ä½è¡¨.csv";
            link.click();
        }
    </script>
</body>
</html>